---
import { SEO } from "astro-seo";
import Schema from "@/components/Schema.astro";

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
  noindex?: boolean;
  pageType?: "home" | "page" | "project" | "contact" | "about";
  breadcrumbs?: Array<{ name: string; url: string }>;
}

const {
  description = "Fábrica de muebles a medida en Chiclayo, Perú. +30 años de experiencia. Closets, cocinas, dormitorios, comedores y más. ¡Cotiza gratis!",
  title = "Ebanos Muebles",
  image = "/assets/og-image.webp",
  type = "website",
  noindex = false,
  pageType = "page",
  breadcrumbs = [],
} = Astro.props;

const siteUrl = "https://ebanosmuebles.com";
const fullTitle =
  title === "Ebanos Muebles" ? title : `${title} | Ebanos Muebles`;
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).href;
const ogImageUrl = image.startsWith("http") ? image : `${siteUrl}${image}`;
---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />

<!-- Preload LCP image PRIMERO - crítico para performance -->
<link
  rel="preload"
  href="/assets/image1.webp"
  as="image"
  type="image/webp"
  fetchpriority="high"
/>

<!-- Preload fuentes críticas -->
<link
  rel="preload"
  href="/fonts/Inter.woff2"
  as="font"
  type="font/woff2"
  crossorigin="anonymous"
/>
<link
  rel="preload"
  href="/fonts/Clash.woff2"
  as="font"
  type="font/woff2"
  crossorigin="anonymous"
/>

<link rel="icon" type="image/svg+xml" href="/favicon.webp" />
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
<link rel="sitemap" href="/sitemap-index.xml" />

<SEO
  title={fullTitle}
  description={description}
  canonical={canonicalUrl}
  noindex={noindex}
  openGraph={{
    basic: {
      title: title,
      type: type,
      image: ogImageUrl,
      url: canonicalUrl,
    },
    optional: {
      description: description,
      locale: "es_PE",
      siteName: "Ebanos Muebles",
    },
    image: {
      alt: "Ebanos Muebles - Muebles de alta calidad en Chiclayo",
      width: 1200,
      height: 630,
    },
  }}
  twitter={{
    card: "summary_large_image",
    site: "@ebanosmuebles",
    creator: "@ebanosmuebles",
    title: title,
    image: ogImageUrl,
    imageAlt: "Ebanos Muebles - Muebles de alta calidad en Chiclayo",
    description: description,
  }}
  extend={{
    meta: [
      { name: "author", content: "Ebanos Muebles" },
      { name: "geo.region", content: "PE-LAM" },
      { name: "geo.placename", content: "Chiclayo, Lambayeque" },
      { name: "geo.position", content: "-6.7713;-79.8408" },
      { name: "ICBM", content: "-6.7713, -79.8408" },
      { name: "theme-color", content: "#1a1a1a" },
      {
        name: "robots",
        content: noindex
          ? "noindex, nofollow"
          : "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",
      },
      { name: "googlebot", content: "index, follow" },
      { name: "bingbot", content: "index, follow" },
    ],
  }}
/>

<Schema
  type={pageType}
  pageTitle={fullTitle}
  pageDescription={description}
  breadcrumbs={breadcrumbs}
/>

<script is:inline>
  window.dataLayer = window.dataLayer || [];

  function loadGTM() {
    if (window.gtmLoaded) return;
    window.gtmLoaded = true;

    var script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtm.js?id=GTM-KF6L4554";
    document.head.appendChild(script);

    window.dataLayer.push({
      "gtm.start": new Date().getTime(),
      event: "gtm.js",
    });
  }

  // Cargar GTM después de interacción o después de 3 segundos (lo que ocurra primero)
  var gtmTimeout = setTimeout(loadGTM, 3000);
  
  ['scroll', 'click', 'touchstart', 'mousemove', 'keydown'].forEach(function(event) {
    document.addEventListener(event, function handler() {
      clearTimeout(gtmTimeout);
      loadGTM();
      document.removeEventListener(event, handler);
    }, { once: true, passive: true });
  });

  document.addEventListener("astro:page-load", function () {
    if (window.gtmLoaded) {
      window.dataLayer.push({
        event: "page_view",
        page_path: window.location.pathname,
        page_title: document.title,
      });
    }
  });
</script>
