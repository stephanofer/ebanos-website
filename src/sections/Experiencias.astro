---
import { getCollection, type CollectionEntry } from "astro:content";
import SectionContainer from "@/components/SectionContainer.astro";
import TestimonialCard from "@/components/TestimonialCard.astro";

const testimonios: CollectionEntry<"testimonios">[] = await getCollection("testimonios");

// Ordenar por fecha (más recientes primero) y luego por puntuación
const testimoniosOrdenados = testimonios.sort((a, b) => {
  // Primero por puntuación (mayor primero)
  if (b.data.puntuacion !== a.data.puntuacion) {
    return b.data.puntuacion - a.data.puntuacion;
  }
  // Luego por fecha si existe
  const fechaA = a.data.fecha?.getTime() ?? 0;
  const fechaB = b.data.fecha?.getTime() ?? 0;
  return fechaB - fechaA;
});
---

<SectionContainer name="testimonios">
  <div class="testimonials-section">
    <div class="testimonials-header">
      <h2>#HogaresEbanos</h2>
      <p>
        Inspira a nuestra comunidad y muéstranos cómo ha quedado tu hogar Ebanos.
      </p>
    </div>

    <!-- Marquee Container - respeta el max-width del padre -->
    <div class="marquee-wrapper">
      <button id="prev-btn" class="nav-btn prev" aria-label="Anterior testimonio">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button id="next-btn" class="nav-btn next" aria-label="Siguiente testimonio">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
      </button>

      <div class="marquee-container">
        <div class="marquee-track" aria-label="Testimonios de clientes">
          <!-- Primera fila de testimonios -->
          <div class="marquee-content">
            {testimoniosOrdenados.map((testimonio) => (
              <TestimonialCard
                nombre={testimonio.data.nombre}
                ubicacion={testimonio.data.ubicacion}
                titulo={testimonio.data.titulo}
                descripcion={testimonio.body ?? ""}
                tag={testimonio.data.tag}
                imagenProyecto={testimonio.data.imagenProyecto}
                imagenAvatar={testimonio.data.imagenAvatar}
                puntuacion={testimonio.data.puntuacion}
              />
            ))}
          </div>
          <!-- Duplicamos para el efecto infinito -->
          <div class="marquee-content" aria-hidden="true">
            {testimoniosOrdenados.map((testimonio) => (
              <TestimonialCard
                nombre={testimonio.data.nombre}
                ubicacion={testimonio.data.ubicacion}
                titulo={testimonio.data.titulo}
                descripcion={testimonio.body ?? ""}
                tag={testimonio.data.tag}
                imagenProyecto={testimonio.data.imagenProyecto}
                imagenAvatar={testimonio.data.imagenAvatar}
                puntuacion={testimonio.data.puntuacion}
              />
            ))}
          </div>
        </div>
      </div>
      
      <!-- Gradientes para fade effect en los bordes -->
      <div class="fade-overlay fade-left"></div>
      <div class="fade-overlay fade-right"></div>
    </div>
  </div>
</SectionContainer>

<style>
  .testimonials-section {
    margin: 4rem 0;
    position: relative;
  }

  .testimonials-header {
    margin-bottom: 2.5rem;
  }

  h2 {
    font-family: "Clash";
    font-weight: 500;
    font-size: var(--fs-xl);
    line-height: 1.2;
    color: var(--foreground);
    margin-bottom: 0.5rem;
    letter-spacing: -0.02em;
  }

  .testimonials-header p {
    font-family: "Inter", sans-serif;
    font-size: var(--fs-base);
    line-height: 1.6;
    color: var(--secondary);
    max-width: 600px;
    font-weight: 400;
    margin: 0;
  }

  /* Marquee Wrapper - contenedor con overflow y gradientes */
  .marquee-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
  }

  /* Marquee Container */
  .marquee-container {
    overflow-x: auto;
    overflow-y: hidden;
    position: relative;
    /* Ocultar scrollbars pero mantener funcionalidad */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
    /* Evitar comportamientos de scroll nativo que interfieran con el JS suave */
    scroll-behavior: auto;
  }

  .marquee-container::-webkit-scrollbar {
    display: none;
  }

  .marquee-track {
    display: flex;
    width: max-content;
    /* Eliminamos la animación CSS pura para dar control al usuario */
  }

  .marquee-content {
    display: flex;
    gap: 1.5rem;
    padding: 1rem 0.75rem;
    /* Aseguramos que el contenido no se rompa */
    flex-shrink: 0;
  }

  /* Navigation Buttons */
  .nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    opacity: 1;
    color: var(--foreground);
  }

  .nav-btn:hover {
    background: var(--foreground);
    color: white;
    scale: 1.1;
  }

  .prev { left: 1rem; }
  .next { right: 1rem; }

  /* Fade overlays para bordes suaves */
  .fade-overlay {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 60px;
    pointer-events: none;
    z-index: 10;
  }

  .fade-left {
    left: 0;
    background: linear-gradient(to right, white 0%, transparent 100%);
  }

  .fade-right {
    right: 0;
    background: linear-gradient(to left, white 0%, transparent 100%);
  }

  @media (max-width: 768px) {
    .nav-btn {
      display: none;
    }

    .testimonials-section {
      margin-top: 3rem;
    }

    h2 {
      font-size: var(--fs-lg);
    }

    .testimonials-header p {
      font-size: var(--fs-sm);
    }

    .marquee-content {
      gap: 1rem;
    }

    .fade-overlay {
      width: 40px;
    }
  }

  @media (max-width: 480px) {
    h2 {
      font-size: var(--fs-lg);
    }

    .marquee-content {
      gap: 0.75rem;
      padding: 0.5rem;
    }

    .fade-overlay {
      width: 24px;
    }
  }
</style>

<script>
  // UX Improvement: Interactive Infinite Scroll
  // Permite al usuario detener, arrastrar y navegar libremente por los testimonios
  // mientras mantiene el movimiento automático atractivo cuando está inactivo.
  
  function initMarquee() {
    const container = document.querySelector('.marquee-container') as HTMLElement;
    const content = document.querySelector('.marquee-content') as HTMLElement;
    
    if (!container || !content) return;

    let isPaused = false;
    let autoScrollSpeed = 0.3; // Velocidad base (px/frame)
    
    // Configuración de interacción
    const pause = () => isPaused = true;
    const resume = () => isPaused = false;

    // Botones de navegación
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    if (prevBtn && nextBtn) {
      // Pausar al interactuar con los botones
      prevBtn.addEventListener('mouseenter', pause);
      prevBtn.addEventListener('mouseleave', resume);
      nextBtn.addEventListener('mouseenter', pause);
      nextBtn.addEventListener('mouseleave', resume);

      prevBtn.addEventListener('click', () => {
        container.scrollBy({ left: -350, behavior: 'smooth' });
      });
      nextBtn.addEventListener('click', () => {
        container.scrollBy({ left: 350, behavior: 'smooth' });
      });
    }

    // --- Eventos de Hover (Pausa simple) ---
    container.addEventListener('mouseenter', pause);
    container.addEventListener('mouseleave', resume);
    
    // --- Eventos Táctiles (Móvil) ---
    container.addEventListener('touchstart', pause, { passive: true });
    container.addEventListener('touchend', () => {
      setTimeout(resume, 1500);
    }, { passive: true });

    // Loop de animación
    function animate() {
      if (!isPaused) {
        // Movimiento automático
        container.scrollLeft += autoScrollSpeed;
      }

      // Lógica de Loop Infinito
      // Si llegamos al final del primer set, saltamos al inicio (sin animación)
      if (container.scrollLeft >= content.offsetWidth) {
        container.scrollLeft -= content.offsetWidth;
      } 
      // Si el usuario hace scroll manual hacia atrás más allá del inicio
      else if (container.scrollLeft <= 0) {
        container.scrollLeft += content.offsetWidth;
      }

      requestAnimationFrame(animate);
    }

    // Iniciar animación
    requestAnimationFrame(animate);
  }

  // Inicializar
  document.addEventListener('astro:page-load', initMarquee);
  document.addEventListener('DOMContentLoaded', initMarquee);
</script>