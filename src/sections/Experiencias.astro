---
import { getCollection, type CollectionEntry } from "astro:content";
import SectionContainer from "@/components/SectionContainer.astro";
import TestimonialCard from "@/components/TestimonialCard.astro";

const testimonios: CollectionEntry<"testimonios">[] = await getCollection("testimonios");

// Ordenar por fecha (más recientes primero) y luego por puntuación
const testimoniosOrdenados = testimonios.sort((a, b) => {
  // Primero por puntuación (mayor primero)
  if (b.data.puntuacion !== a.data.puntuacion) {
    return b.data.puntuacion - a.data.puntuacion;
  }
  // Luego por fecha si existe
  const fechaA = a.data.fecha?.getTime() ?? 0;
  const fechaB = b.data.fecha?.getTime() ?? 0;
  return fechaB - fechaA;
});
---

<SectionContainer name="testimonios">
  <div class="testimonials-section">
    <div class="testimonials-header">
      <h2>#HogaresEbanos</h2>
      <p>
        Inspira a nuestra comunidad y muéstranos cómo ha quedado tu hogar Ebanos.
      </p>
    </div>

    <!-- Marquee Container - respeta el max-width del padre -->
    <div class="marquee-wrapper">
      <div class="marquee-container">
        <div class="marquee-track" aria-label="Testimonios de clientes">
          <!-- Primera fila de testimonios -->
          <div class="marquee-content">
            {testimoniosOrdenados.map((testimonio) => (
              <TestimonialCard
                nombre={testimonio.data.nombre}
                ubicacion={testimonio.data.ubicacion}
                titulo={testimonio.data.titulo}
                descripcion={testimonio.body ?? ""}
                tag={testimonio.data.tag}
                imagenProyecto={testimonio.data.imagenProyecto}
                imagenAvatar={testimonio.data.imagenAvatar}
                puntuacion={testimonio.data.puntuacion}
              />
            ))}
          </div>
          <!-- Duplicamos para el efecto infinito -->
          <div class="marquee-content" aria-hidden="true">
            {testimoniosOrdenados.map((testimonio) => (
              <TestimonialCard
                nombre={testimonio.data.nombre}
                ubicacion={testimonio.data.ubicacion}
                titulo={testimonio.data.titulo}
                descripcion={testimonio.body ?? ""}
                tag={testimonio.data.tag}
                imagenProyecto={testimonio.data.imagenProyecto}
                imagenAvatar={testimonio.data.imagenAvatar}
                puntuacion={testimonio.data.puntuacion}
              />
            ))}
          </div>
        </div>
      </div>
      
      <!-- Gradientes para fade effect en los bordes -->
      <div class="fade-overlay fade-left"></div>
      <div class="fade-overlay fade-right"></div>
    </div>
  </div>
</SectionContainer>

<style>
  .testimonials-section {
    margin: 4rem 0;
    position: relative;
  }

  .testimonials-header {
    margin-bottom: 2.5rem;
  }

  h2 {
    font-family: "Clash";
    font-weight: 500;
    font-size: var(--fs-xl);
    line-height: 1.2;
    color: var(--foreground);
    margin-bottom: 0.5rem;
    letter-spacing: -0.02em;
  }

  .testimonials-header p {
    font-family: "Inter", sans-serif;
    font-size: var(--fs-base);
    line-height: 1.6;
    color: var(--secondary);
    max-width: 600px;
    font-weight: 400;
    margin: 0;
  }

  /* Marquee Wrapper - contenedor con overflow y gradientes */
  .marquee-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
  }

  /* Marquee Container */
  .marquee-container {
    overflow: hidden;
    position: relative;
  }

  .marquee-track {
    display: flex;
    width: max-content;
    animation: marquee 45s linear infinite;
  }

  .marquee-container:hover .marquee-track {
    animation-play-state: paused;
  }

  .marquee-content {
    display: flex;
    gap: 1.5rem;
    padding: 1rem 0.75rem;
  }

  @keyframes marquee {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /* Fade overlays para bordes suaves */
  .fade-overlay {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 60px;
    pointer-events: none;
    z-index: 10;
  }

  .fade-left {
    left: 0;
    background: linear-gradient(to right, white 0%, transparent 100%);
  }

  .fade-right {
    right: 0;
    background: linear-gradient(to left, white 0%, transparent 100%);
  }

  @media (max-width: 768px) {
    .testimonials-section {
      margin-top: 3rem;
    }

    h2 {
      font-size: var(--fs-lg);
    }

    .testimonials-header p {
      font-size: var(--fs-sm);
    }

    .marquee-content {
      gap: 1rem;
    }

    .marquee-track {
      animation-duration: 35s;
    }

    .fade-overlay {
      width: 40px;
    }
  }

  @media (max-width: 480px) {
    h2 {
      font-size: var(--fs-lg);
    }

    .marquee-content {
      gap: 0.75rem;
      padding: 0.5rem;
    }

    .marquee-track {
      animation-duration: 30s;
    }

    .fade-overlay {
      width: 24px;
    }
  }

  /* Reduced motion support para accesibilidad */
  @media (prefers-reduced-motion: reduce) {
    .marquee-track {
      animation: none;
      flex-wrap: wrap;
      justify-content: center;
    }

    .marquee-content:nth-child(2) {
      display: none;
    }

    .marquee-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .fade-overlay {
      display: none;
    }
  }
</style>

<script>
  // Mejora de accesibilidad: permite scroll manual con el teclado
  document.addEventListener('DOMContentLoaded', () => {
    const marqueeContainer = document.querySelector('.marquee-container');
    if (marqueeContainer) {
      marqueeContainer.addEventListener('keydown', (e) => {
        const event = e as KeyboardEvent;
        if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
          const scrollAmount = event.key === 'ArrowLeft' ? -200 : 200;
          marqueeContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
      });
    }
  });
</script>